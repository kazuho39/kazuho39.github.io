# Supabase
## 概要
Supabaseは、PostgreSQLを基盤としたオープンソースのBaaS(Backend as a Service)。  
データベース、認証、ストレージ、リアルタイムAPIなどを自動生成し、バックエンドを高速に構築できる。  
Firebaseの代替として設計されており、SQLベースで柔軟なデータ操作が可能。  

## 用語
### Row Level Security(RLS)
行単位のアクセス制御を行うPostgreSQL機能。Supabaseでは必須の概念。

### Policy
RLSを実現するルール定義。特定ユーザーの読み書きを制限できる。

### Anon/Auth Role
匿名ユーザーと認証済みユーザーのロール。  
RLSでの条件分岐に利用。

## APIキー
| 種類                   | 主な用途             | 権限                | 利用場所            |
| -------------------- | ---------------- | ----------------- | --------------- |
| **anon key**         | フロントエンド（ブラウザなど）  | 制限付き（RLS有効）       | クライアント公開可       |
| **service_role key** | バックエンド（サーバー・API） | **フルアクセス（RLS無効）** | 絶対にクライアントに公開しない |

### 仕組み
Supabaseでは、PostgreSQLの Row Level Security（RLS） によってユーザーごとのアクセス制御を行う。  
しかし、管理者やサーバーサイド処理（例：バッチ・Webhook受信など）では「すべての行にアクセスしたい」ことがある。  
そのために使うのが service_role キー。  

このキーを使うと：  
- RLSを無視して すべてのテーブル・データにアクセスできる
- 挿入・更新・削除・ユーザー管理などの管理操作 が可能

### よくある使い方
| 利用シーン             | 説明                                                                  |
| ----------------- | ------------------------------------------------------------------- |
| **サーバーAPIでのDB操作** | Next.js API Route や Cloud Function などで、`service_role`キーを使って安全にDB更新。 |
| **Cronジョブやバッチ処理** | 定期実行で全データ集計・更新を行う。                                                  |
| **Webhook受信処理**   | 外部サービスからのイベントを受け取り、管理者権限でDBに反映。                                     |

