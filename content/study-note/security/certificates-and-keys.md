# 証明書と鍵
## 証明書と鍵とは？
### 鍵（Key）とは？
Tの世界で言う「鍵」は、 **データを暗号化したり、署名をつけたり、認証したりするために使う“秘密の文字列”** です。  
とくに「公開鍵暗号方式（非対称暗号）」では、2つの鍵をペアで使います  
- 公開鍵（public key）：誰にでも公開してよい鍵。暗号化や署名の検証に使います。
- 秘密鍵（private key）：絶対に漏らしてはいけない鍵。復号や署名の作成に使います。

この「片方で暗号化したものは、もう片方でしか復号できない」という仕組みを使って、安全な通信や信頼性のある認証を実現しています。


### 証明書（Certificate）とは？
証明書は、「この公開鍵は確かにこの人（この組織）のものです」と **第三者が保証してくれる“デジタルな身分証明書”** のようなものです。  
具体的には、以下の情報が含まれています  
- 公開鍵（public key）
- 所有者の情報（会社名やドメインなど）
- 発行者（認証局、CA）の署名
- 有効期限などのメタ情報

この証明書により、たとえば「https://example.com にアクセスしているけど、本当にそのサイトが例の会社なのか？」を確認する手段になります。

### どう使われるか
証明書と鍵は、以下のような場面で広く使われています

| 使用例        | 内容                                 |
| ---------- | ---------------------------------- |
| 🔒 HTTPS通信 | Webサイトとブラウザ間の通信を暗号化（TLS）           |
| 📲 API認証   | JWT（署名付きトークン）やOAuth2の連携            |
| 📎 電子署名    | 文書やリクエストが改ざんされていないことを証明            |
| 🔐 SSO認証   | SAMLやOpenID ConnectでのID連携における信頼の担保 |

イメージで例えると
- 公開鍵：誰でも受け取ってOKな「南京錠」
- 秘密鍵：自分しか持ってはいけない「南京錠の鍵」
- 証明書：その南京錠が「○○会社製のものである」と書かれた「保証書」

## 公開鍵と秘密鍵
### 公開鍵暗号とは？
**公開鍵暗号方式（非対称暗号）**は、次のような2つの鍵をペアで使う暗号技術です
- 公開鍵（Public Key）：誰にでも公開していい鍵
- 秘密鍵（Private Key）：絶対に他人に渡してはいけない鍵

この2つは数学的に関連していて、「片方で暗号化したデータは、もう片方でしか復号できない」という特徴があります。

### 公開鍵と秘密鍵の使い方（2通り）
#### ① 暗号化の用途（秘密を守る）
| 目的                | 使う鍵            | できること                   |
| ----------------- | -------------- | ----------------------- |
| **相手にだけ読めるようにする** | 相手の**公開鍵**で暗号化 | 相手だけが持っている**秘密鍵**で復号できる |

たとえば、あなたのAPIにデータを送るとき、あなたの「公開鍵」で暗号化しておけば、復号できるのは「あなたの秘密鍵」を持っているあなただけです。

#### ② 署名（認証）の用途（本人確認＋改ざん防止）
| 目的                     | 使う鍵           | できること               |
| ---------------------- | ------------- | ------------------- |
| **データが本当に本人から来たことを証明** | 自分の**秘密鍵**で署名 | 誰でも自分の**公開鍵**で検証できる |

イメージ：  
「このメッセージは確かに私が書いたものです」と証明したいときに使います。  
→ 公開鍵を持っていれば「この署名が本人の秘密鍵で作られた」ことが検証できる。

### 具体例：どこで使われてる？
| 利用シーン           | 公開鍵と秘密鍵の使い方                 |
| --------------- | --------------------------- |
| 🔒 HTTPS通信（TLS） | サーバーが証明書に含まれる公開鍵で暗号化、秘密鍵で復号 |
| 📧 メール暗号化（PGP）  | 相手の公開鍵で暗号化、自分の秘密鍵で署名        |
| 🛡️ JWTの署名検証    | 発行者の秘密鍵で署名、受信者は公開鍵で検証       |
| 🧾 電子契約・署名      | 自分の秘密鍵で署名、公開鍵で検証される         |

**【暗号化】**  
🔒 公開鍵は「誰でも使える南京錠」  
🔑 秘密鍵は「その南京錠を開けられる唯一の鍵」  

**【署名】**  
✍️ 秘密鍵は「自分しか書けないサイン」  
🧾 公開鍵は「そのサインが本物かどうか確認する検証道具」

## デジタル証明書（X.509証明書）
### デジタル証明書とは？
デジタル証明書とは、  
「この公開鍵は確かに○○のものですよ」と  
**信頼できる第三者（認証局／CA）が保証してくれるデジタルな“身分証明書”** です。

主に使われているのは X.509 というフォーマットの証明書です。  
インターネット上の安全な通信（HTTPSなど）では、このX.509証明書が必須です。

### 証明書の中身
X.509証明書には、次のような情報が入っています

| 項目             | 説明                        |
| -------------- | ------------------------- |
| 公開鍵            | 暗号化・署名検証に使う鍵              |
| 所有者情報（Subject） | この鍵が誰のものか（例：example.com）  |
| 発行者情報（Issuer）  | 誰がこの証明書を発行したか（例：DigiCert） |
| 有効期限           | いつからいつまで有効か               |
| シリアル番号         | 一意に識別するための番号              |
| 署名             | 発行者が「この証明書は正しい」と保証する電子署名  |

### なぜ信頼できるのか？
→ 「信頼の連鎖（Trust Chain）」があるから  
あなたのPCやスマホには「ルート証明書」が最初から入っている  
中間認証局（Intermediate CA）がそのルートCAに署名されている  
実際のサーバー証明書（エンドエンティティ証明書）は、中間CAから署名されている  

つまり：  
最初から信頼しているCA → そこから段階的に信頼されている証明書  
という「信頼のチェーン」が成立しているからです。  

### 自己署名証明書（Self-signed certificate）とは？
- 認証局ではなく、自分自身で作った証明書
- 公開鍵の所有者自身が署名している
- 社内システムや開発環境で使われることが多いが、外部のユーザーやブラウザからは信頼されない

### 実際に使われる場所
| サービス                            | 証明書の役割                      |
| ------------------------------- | --------------------------- |
| HTTPS通信（TLS）                    | Webサーバーが「このドメインの証明書です」と提示する |
| Salesforce / AWS / Google Cloud | API連携時に自社の証明書を登録して相互認証する    |
| 電子契約サービス                        | 「この書類にこの人が署名した」という証明に使う     |

### まとめ
- X.509証明書は「公開鍵」と「その所有者が誰か」を証明するためのもの
- 「認証局（CA）の署名」があることで信頼できる
- 信頼の仕組みは「信頼の連鎖（Trust Chain）」によって構成される

## TLS/SSL通信と証明書
### TLSとは？
TLS（Transport Layer Security）は、インターネット上の通信を暗号化して安全にするプロトコルです。  
以前はSSL（Secure Sockets Layer）と呼ばれていましたが、現在はTLSが標準です。  
よく見かける HTTPS は、「HTTP + TLS」という意味です。

### TLS通信の目的
| 目的    | 説明                       |
| ----- | ------------------------ |
| ✅ 暗号化 | 通信内容が盗み見られないようにする        |
| ✅ 認証  | 通信相手が本物であることを確認する        |
| ✅ 完全性 | 通信内容が途中で改ざんされていないことを保証する |

### TLS通信の流れ（ざっくり）
HTTPSサイトにアクセスすると、以下のような流れでTLS通信が始まります：

- (1) クライアント → サーバー
  - 「TLS通信を始めたいです」とリクエスト（＝クライアントHello）
- (2) サーバー → クライアント
  - サーバーの**証明書（X.509）**を送る
  - 「この証明書の公開鍵で暗号化してね」と伝える
- (3) クライアント側で検証
  - サーバー証明書が信頼できるCAから発行されているかをチェック
  - ドメイン名と一致しているか、有効期限内かを確認
- (4)  共通鍵（セッションキー）の交換
  - クライアントが共通鍵（対称鍵）をサーバーの公開鍵で暗号化
  - サーバーだけが秘密鍵でそれを復号できる
- (5) 暗号化通信スタート
  - このあとは、共通鍵を使って対称暗号方式で通信

### なぜ証明書が必要なの？
サーバーが「自分は example.com です」と言っても、それが本当かどうかはわかりません。  
→ そこで、第三者（認証局）が署名した証明書を提示することで、  
「これは確かに example.com の所有者が持っている公開鍵です」と証明できるようになっています。

### ブラウザで起こっていること
- アクセス時に証明書をチェックしている
- 信頼できない証明書だった場合：「この接続は安全ではありません」と警告が出る
- 逆に、有効であれば🔒マークが表示され、TLS通信が成立

### 実務でのポイント
| 観点         | 注意点                                                                  |
| ---------- | -------------------------------------------------------------------- |
| 証明書の有効期限   | 切れると「接続できない」などのトラブルに直結                                               |
| ドメインとの一致   | 証明書に `*.example.com` とある場合、`sub.example.com` はOKだが `example.net` はNG |
| サーバー証明書の更新 | Let's Encryptなら自動更新、商用CAでは手動更新が必要なことも                                |

### まとめ
- TLSは、HTTPSなどで安全な通信を実現する仕組み
- 証明書（X.509）が使われることで「相手が本物かどうか」も確認できる
- 公開鍵は通信の暗号化、署名、認証など多くの役割を担っている

## 証明書の形式と管理
### なぜ証明書の「形式」や「管理」が重要なのか？
証明書や鍵はファイルとして扱われるため、形式や保管方法を理解しておかないと実際に使えません。  
間違った形式を使ったり、期限切れになったりすると通信できなくなるため、正しい管理が必要不可欠です。

### よく使われるファイル形式
| 拡張子             | 内容                                  | 特徴                       |
| --------------- | ----------------------------------- | ------------------------ |
| `.pem`          | 証明書や鍵を**Base64エンコード＋ヘッダ付き**で保存      | 汎用性が高く、よく使われる（中身はテキスト）   |
| `.crt` / `.cer` | 一般的な証明書ファイル（PEMまたはDER形式）            | `.pem`と同じ中身のことも多い        |
| `.key`          | 秘密鍵を保存するファイル                        | `.pem`形式で保存されることが多い      |
| `.der`          | **バイナリ形式**の証明書（PEMの非テキスト版）          | Java系などで使われることがある        |
| `.pfx` / `.p12` | 証明書と秘密鍵を**1つのファイルにまとめた形式（PKCS#12）** | パスワード付き、Windows環境などでよく使う |

#### 証明書と鍵のファイル構成（例）
```markdown
server.crt   ← 公開鍵入りの証明書（PEM形式）
server.key   ← 秘密鍵（絶対に漏らしてはいけない）

または

fullchain.pem  ← サーバー証明書＋中間証明書のセット
privkey.pem    ← 秘密鍵
```

### 有効期限と更新の管理
#### 証明書には必ず「有効期限」がある！
証明書の有効期限が切れると、HTTPSやAPI通信がエラーになる  
例：「証明書が無効です」「セキュアな接続ができません」などのブラウザ警告

### まとめ
| ポイント          | 説明                         |
| ------------- | -------------------------- |
| 証明書には多くの形式がある | PEM, CRT, PFX など目的に応じて使い分け |
| 秘密鍵とセットで運用される | セキュリティ上、厳重な管理が必要           |
| 有効期限の管理が重要    | 通信トラブルの主な原因にもなるので注意        |

## 実践ユースケース（Salesforceを含む）
### ① Salesforceにおける証明書の使い道
#### 主な用途：
| 用途                        | 説明                                |
| ------------------------- | --------------------------------- |
| 🔐 **JWTベアラーフロー（OAuth2）** | 外部APIとの**トークン取得時の署名**に使う          |
| 🪪 **SAML（シングルサインオン）**    | IDプロバイダとして動作する際、**SAMLレスポンスに署名**  |
| 🌍 **外部サイトとのHTTPS連携**     | **証明書ベースの認証**が必要なAPI連携（双方向TLS）で使う |

#### Salesforceの管理画面でできること
- 「証明書と鍵の管理」から自己署名証明書を発行・確認
- 有効期限の通知（期限切れ前に警告）
- 秘密鍵はSalesforce側で管理（外部にダウンロードできない）

### ② OAuth2 JWTベアラーフロー（Salesforceでよく使う）
Salesforceが外部サービスにログインする際、以下の流れで証明書（秘密鍵）を使って署名付きリクエストを送ります。  

フロー概要：  
- (1) Salesforceに証明書を登録（.crtと秘密鍵セット）
- (2) ApexコードまたはNamed CredentialでJWTを作成
- (3) 秘密鍵でJWTに署名
- (4) 外部認証サーバーにトークンを取得しに行く（→アクセストークンを得る）
- (5) トークンを使って外部APIをコール

🔒 この署名部分に秘密鍵が使われ、受け取る側が公開鍵（証明書）で検証します。

### ③ APIでの相互TLS認証（双方向SSL）
- 通常のHTTPSは「サーバー側の証明書のみ」提示
- 相互TLSでは、クライアント側（Salesforceなど）も証明書を提示する

Salesforceでの対応方法  
- 「名前付き資格情報（Named Credential）」で証明書を添付
- Apexで callout: を使うと、Salesforceが自動で証明書付きで通信してくれる

### ④ 電子契約・文書署名（業務外でも参考になる応用）
- DocuSign、Adobe Sign などの電子契約サービスは、証明書で電子署名を行い、署名者を証明
- 政府や法律分野でも使われる技術

### 実務でのチェックポイント
| 項目       | チェック内容                                 |
| -------- | -------------------------------------- |
| 証明書の有効期限 | 切れる前に更新通知を受け取る・計画的に差し替え                |
| 鍵のペアの一致  | 署名エラーは大抵「証明書と秘密鍵がズレてる」ことが原因            |
| 証明書の保存場所 | 秘密鍵は厳重に管理。Salesforceでは外部公開されない仕組み      |
| 使用目的     | JWT署名、HTTPS接続、SAML、双方向TLSなど、目的に応じて使い分け |

### まとめ
- SalesforceではAPI連携やSSOにおいて、証明書と鍵がよく使われる
- JWT署名やSAML署名など、「署名」としての用途が多い
- 管理画面やNamed Credentialと連携することで、安全かつ簡単に使える

## よくある質問とトラブルシュート
### Q1. 証明書の有効期限が切れるとどうなる？
**🔍 問題：：**  
- HTTPS接続で「この接続は安全ではありません」「証明書が無効です」と表示される
- API通信がエラー（例えば：SSL handshake failed）

**✅ 解決策：**  
- 期限が切れる前に、証明書を更新（再発行）し、サーバーに再設定する
- Salesforceでは、[証明書と鍵の管理] 画面で有効期限が確認できる

### Q2. 「証明書と秘密鍵が合っていない」と言われる
**🔍 問題：**  
- サーバーが起動しない／TLS通信に失敗
- 「key does not match cert」といったエラー

**✅ 解決策：**  
- 証明書と秘密鍵が正しいペアか確認（opensslなどで照合可能）
```bash
# 証明書と秘密鍵のモジュラス値を比較
openssl x509 -noout -modulus -in server.crt | openssl md5
openssl rsa  -noout -modulus -in server.key | openssl md5
```

### Q3. 自己署名証明書を使ったら「信頼できない」と出る
**🔍 問題：**  
- ブラウザやAPIクライアントがエラー（「この証明書は信頼されていません」）

**✅ 解決策：**
- 開発環境なら「証明書例外を許可」
- 本番環境では信頼された認証局（CA）で署名された証明書を使う

### Q4. 証明書を更新したのに、まだ古いまま扱われる
**🔍 問題：**
- ブラウザに古い証明書がキャッシュされている
- サーバーが再起動されていない

**✅ 解決策：**
- サーバー（例：Apache, Nginx）を再起動
- ブラウザのキャッシュやローカル証明書情報を削除

### Q5. 証明書の形式が合わずに読み込めない（PEM? DER?）
**✅ 解決策：**
- .pem形式（Base64テキスト形式）に変換して再利用する
```bash
# DER形式 → PEM形式に変換
openssl x509 -inform DER -in certificate.cer -out certificate.pem
```

### その他Tips
| トラブル                | チェックポイント                        |
| ------------------- | ------------------------------- |
| SSL handshake error | 相手の証明書が正しいか、有効か                 |
| Unexpected EOF      | 鍵や証明書ファイルの改行ミス、文字化け             |
| SalesforceでAPIが失敗   | Named Credentialの証明書設定が合っているか確認 |

### まとめ
- 証明書関連のトラブルは「有効期限／ペア不一致／信頼されない証明書」が3大原因
- トラブル時は OpenSSLなどのコマンドラインツールでの確認が有効
- Salesforceでも、証明書の期限管理や設定ミスはよくあるので定期的に確認を！

