# AWSでのネットワーク構築
## AWSネットワーク構築の主な要素と役割

| 要素                             | 説明                                                       |
| ------------------------------ | -------------------------------------------------------- |
| **VPC（Virtual Private Cloud）** | 仮想ネットワークの基本単位。AWS上に自分専用のネットワークを作る                        |
| **サブネット（Subnet）**              | VPC内のIPアドレス範囲を区切ったもの。**パブリック**（外部公開）と**プライベート**（内部用）に分ける |
| **インターネットゲートウェイ（IGW）**         | VPCとインターネットを接続するためのゲートウェイ                                |
| **NAT Gateway**                | プライベートサブネットにあるサーバーがインターネットに出るための出口（逆方向は禁止）               |
| **ルートテーブル**                    | 各サブネットがどこへ通信できるかを制御する                                    |
| **セキュリティグループ（SG）**             | サーバー単位のファイアウォール（許可ベース）                                   |
| **ネットワークACL（NACL）**            | サブネット単位のファイアウォール（許可＋拒否の両方が設定可能）                          |
| **ELB（Elastic Load Balancer）** | 外部からのアクセスを複数のEC2に分散する                                    |
| **API Gateway**                | サーバーレスなAPI入口。LambdaやHTTPバックエンドへルーティング                    |
| **EC2**                        | 仮想サーバー。WebアプリやAPIをホスト                                    |
| **Lambda**                     | サーバーレス関数。API Gatewayと組み合わせて軽量API構築に最適                    |

### シンプルな構成図
![構成図イメージ](../../public/img/study-note/network/aws-network/aws-network-image.png)

## VPC(Virtual Private Cloud)
VPCは、 **AWS上に構築する、自分専用の仮想ネットワーク**。  
自由にサブネット(小さなネットワーク)を作ったり、インターネットとの接続を制御したいできる。  

### VPCの中に含まれる構成要素
| 要素                 | 説明                            |
| ------------------ | ----------------------------- |
| サブネット              | VPCの中を区切る小さなネットワーク            |
| ルートテーブル            | 通信の行き先（ルート）を定義                |
| インターネットゲートウェイ（IGW） | インターネットとの橋渡し                  |
| NAT Gateway        | プライベートサブネットからのインターネット通信を可能にする |
| セキュリティグループ         | インスタンス単位のファイアウォール             |
| NACL               | サブネット単位のファイアウォール              |

### サブネットとは？
「**サブネット（Subnet）＝ VPCの中をIPで分割したネットワーク領域**」  
通常、**パブリックサブネット**と**プライベートサブネット**に分けて使う。  

#### パブリック vs プライベートサブネット
| 種類                 | 説明               | 使用例                          |
| ------------------ | ---------------- | ---------------------------- |
| 🌐 **パブリックサブネット**  | インターネットと直接通信できる  | API Gateway, ELB, EC2（Web）など |
| 🔒 **プライベートサブネット** | インターネットと直接通信できない | RDS, バッチ処理EC2, 内部API など      |

- Webサーバーはインターネットからアクセスされる必要がある → パブリックサブネット
- データベースは外からアクセスされたくない → プライベートサブネット

#### イメージ構成図

```markdown
【VPC】
├── パブリックサブネット（例：ap-northeast-1a）
│    ├── EC2 (Webサーバ)
│    └── ELB / API Gateway
│
├── プライベートサブネット（例：ap-northeast-1a）
     ├── EC2 (API or バッチ処理)
     └── RDS (DB)
```

## ルートテーブルとインターネットゲートウェイの役割
### インターネットゲートウェイ（Internet Gateway, IGW）
**■ 概要**  
VPCをインターネットと接続するための出入口。  
パブリックサブネットからインターネットに出る／インターネットからアクセスを受けるには、IGWが必須。  

**■ ポイント**  
VPCに1つだけアタッチできる  
パブリックIPやElastic IPとセットで使う  
プライベートサブネットには基本的に使わない  

### ルートテーブル（Route Table）
**■ 概要**  
「このサブネットからの通信は、どこへルーティングするか？」を定義する設定表  

| 宛先（Destination）        | ターゲット（Target）               |
| ---------------------- | --------------------------- |
| `10.0.0.0/16`（自VPC内）   | local（デフォルト）                |
| `0.0.0.0/0`（インターネット全体） | igw-xxxxxxxx（インターネットゲートウェイ） |

**■ ポイント**  
サブネットごとに適用される（サブネットは1つのルートテーブルにだけ関連付け可能）  
パブリック通信を許可するには、0.0.0.0/0 → IGW のルートが必要  

### 両者の関係まとめ
| 目的                | 必要な設定                                                                    |
| ----------------- | ------------------------------------------------------------------------ |
| サブネットからインターネットへ出る | ① IGWをVPCにアタッチ<br>② ルートテーブルに `0.0.0.0/0 → IGW` を設定<br>③ EC2にパブリックIPを割り当て |
| サブネットに外部からアクセスされる | 上記に加えて、セキュリティグループでインバウンド許可                                               |

```markdown
【VPC】
├── IGW（インターネットゲートウェイ）← インターネットとの出入口
│
├── パブリックサブネット（ルート：0.0.0.0/0 → IGW）
│    └── EC2（パブリックIPあり）
│
├── プライベートサブネット（ルート：IGWなし）
     └── RDS（外部アクセス不可）
```

## セキュリティグループ（SG）とネットワークACL（NACL）の違い
### セキュリティグループ（Security Group）
| 項目      | 内容                                 |
| ------- | ---------------------------------- |
| 単位      | **EC2などのリソース単位**で適用（サーバーごと）        |
| 設定方式    | **ホワイトリスト型（許可のみ）**                 |
| 方向      | インバウンド・アウトバウンド両方設定可能               |
| ステートフル性 | ✅ **ステートフル**（一方を許可すれば、戻りの通信も許可される） |
| 例       | `80番ポート（HTTP）を全世界から許可`             |

- AWSでの基本的なファイアウォール
- よく使うのは「Webサーバーに外部からの80番アクセスを許可」など

### ネットワークACL（Network ACL）
| 項目      | 内容                           |
| ------- | ---------------------------- |
| 単位      | **サブネット単位**で適用               |
| 設定方式    | **ホワイトリスト／ブラックリスト両方（許可・拒否）** |
| 方向      | インバウンド・アウトバウンド別々にルール設定       |
| ステートフル性 | ❌ **ステートレス**（戻り通信も明示的に許可が必要） |
| 例       | `特定のIPレンジからのアクセスを拒否`         |

- 拒否（DENY）ルールが書けるため、より細かい制御が可能
- ただし運用がやや複雑なので、基本はセキュリティグループ優先

### 比較表
| 比較項目    | セキュリティグループ   | ネットワークACL        |
| ------- | ------------ | ---------------- |
| 適用範囲    | インスタンス単位     | サブネット単位          |
| 許可／拒否   | 許可のみ         | 許可・拒否 両方可能       |
| ステートフル性 | ✅ ステートフル     | ❌ ステートレス         |
| 通常の用途   | 一般的なファイアウォール | 特定IPのブロックや補助的な制御 |
| 管理のしやすさ | ◎（直感的）       | △（細かい調整が必要）      |

- セキュリティグループだけで大半の構成はOK
  - → EC2/Web/DBに対して、ポート・IP・プロトコルを許可
- 特定のIPブロックを丸ごと拒否したいとき
  - → ネットワークACLでDENYを使って制御（DoS対策など）

```markdown
【VPC】
├── パブリックサブネット（NACLあり）
│    └── EC2（SG：80番・443番許可）
│
└── プライベートサブネット（NACLあり）
     └── RDS（SG：DBポートのみ特定IP許可）
```

## EC2を立ててインターネット公開（ELB付き）
###  必要な構成要素
| 要素                     | 役割                                |
| ---------------------- | --------------------------------- |
| **VPC**                | 自分専用の仮想ネットワーク                     |
| **パブリックサブネット**         | インターネットと通信可能なゾーン                  |
| **インターネットゲートウェイ（IGW）** | VPCとインターネットをつなぐ出入口                |
| **EC2インスタンス**          | WebサーバーやAPIサーバー（例：Nginx, Node.js） |
| **ELB（ALB）**           | 外部アクセスを受けて、EC2に振り分ける              |
| **セキュリティグループ**         | ポートやIPアドレス単位で通信を制御                |

```markdown
           ┌─────────────┐
           │ インターネット │
           └──────┬──────┘
                  ▼
         ┌────────────────┐
         │ Application Load│ ← ELB (ALB)
         │   Balancer (ALB)│
         └──────┬─────────┘
                ▼
        ┌─────────────┐
        │ EC2 (Web/API)│ ← パブリックサブネットに配置
        └─────────────┘
```

### 構築ステップ（ざっくり）
#### 1. VPCとサブネットを作成
VPCを1つ作る（CIDR例：10.0.0.0/16）  
パブリックサブネット（例：10.0.1.0/24）を作成  

#### 2. インターネットゲートウェイをVPCにアタッチ
IGWを作ってVPCに接続  
サブネットのルートテーブルに「0.0.0.0/0 → IGW」のルートを追加  

#### 3. EC2インスタンスを立てる
サブネット：パブリックサブネットを指定  
セキュリティグループ：HTTP(80), HTTPS(443)などを許可  
パブリックIPアドレスを付与  

#### 4. ELB（ALB）を作成してEC2と紐づけ
ターゲットグループを作成してEC2を登録  
ELBのリスナー（ポート80/443）にターゲットグループを接続  

#### 5. ドメインとSSL（任意）
Route53や独自ドメインと接続したり、SSL証明書（ACM）でHTTPS化も可能  

### セキュリティのポイント
| 設定場所            | 設定例                             |
| --------------- | ------------------------------- |
| セキュリティグループ（ELB） | 0.0.0.0/0 → 80, 443 許可          |
| セキュリティグループ（EC2） | ELBのSGからのみ 80 番などを許可（直接外部からは不可） |

EC2でAPIサーバを立てていて、特定のIPアドレスからのリクエストのみ受け付けるという場合は、ELBにIPアドレスをホワイトリストで指定するのが一般的。  

```markdown
[Internet]
   ↓（アクセス元は特定IP）
[ELB（ALB）]
   ↓（ALBのSGでIPホワイトリスト）
[EC2 (APIサーバ)]
   ↑（EC2はALBのSGからの通信だけ許可）
```

### まとめ
| 項目              | 内容                              |
| --------------- | ------------------------------- |
| 外部アクセス受け口       | Application Load Balancer (ALB) |
| 実際のWebアプリ/API実行 | EC2インスタンス上                      |
| セキュリティ          | セキュリティグループとルートテーブルで制御           |
| インターネット接続       | IGWとルーティング設定で実現                 |




